<h1 id="feature-toggle">Feature Toggle</h1>
<h2 id="introduction">Introduction</h2>
<p>While we have more and more features (APIs…) and environments (SIT, Staging…), we want to enable/disable certain features on specific environments by feature toggle.</p>
<p>This article shows how to do feature toggle by two ways</p>
<ul>
<li>Implement IAsyncResourceFilter</li>
<li>Use official package: <a href="https://github.com/microsoft/FeatureManagement-Dotnet">Microsoft.FeatureManagement.AspNetCore</a></li>
</ul>
<p>The full sample code is in my Github: <a href="https://github.com/KarateJB/AspNetCore.Filters.Sample">karatejb/AspNetCore.Filters.Sample</a></p>
<h2 id="implement-iasyncresourcefilter">Implement IAsyncResourceFilter</h2>
<p><strong>Resource filters</strong> will be after Authorization filters and before Action filters and model binding, so we can implement <a href="https://docs.microsoft.com/zh-tw/dotnet/api/microsoft.aspnetcore.mvc.filters.iasyncresourcefilter">IAsynResourceFilter</a> to intercept the request and return 404(Not found) immediately.</p>
<ul>
<li>DisableApiFilter.cs</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">public</span> <span class="kw">class</span> DisableApiFilter : Attribute, IAsyncResourceFilter</a>
<a class="sourceLine" id="cb1-2" title="2">{</a>
<a class="sourceLine" id="cb1-3" title="3">    <span class="kw">private</span> <span class="kw">readonly</span> <span class="dt">string</span> env = <span class="dt">string</span>.<span class="fu">Empty</span>;</a>
<a class="sourceLine" id="cb1-4" title="4"></a>
<a class="sourceLine" id="cb1-5" title="5">    <span class="co">/// </span><span class="kw">&lt;summary&gt;</span></a>
<a class="sourceLine" id="cb1-6" title="6">    <span class="co">/// Constructor</span></a>
<a class="sourceLine" id="cb1-7" title="7">    <span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></a>
<a class="sourceLine" id="cb1-8" title="8">    <span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">&quot;hostEnvironment&quot;</span><span class="kw">&gt;</span><span class="co">IWebHostEnvironment</span><span class="kw">&lt;/param&gt;</span></a>
<a class="sourceLine" id="cb1-9" title="9">    <span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">&quot;options&quot;</span><span class="kw">&gt;</span><span class="co">IOptions</span><span class="kw">&lt;/param&gt;</span></a>
<a class="sourceLine" id="cb1-10" title="10">    <span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">&quot;onEnv&quot;</span><span class="kw">&gt;</span><span class="co">Regex for checking ASPNETCORE_ENVIRONMENT</span><span class="kw">&lt;/param&gt;</span></a>
<a class="sourceLine" id="cb1-11" title="11">    <span class="kw">public</span> <span class="fu">DisableApiFilter</span>(</a>
<a class="sourceLine" id="cb1-12" title="12">        IWebHostEnvironment hostEnvironment,</a>
<a class="sourceLine" id="cb1-13" title="13">        IOptions&lt;AppSettings&gt; options,</a>
<a class="sourceLine" id="cb1-14" title="14">        <span class="dt">string</span> onEnv = <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb1-15" title="15">    {</a>
<a class="sourceLine" id="cb1-16" title="16">        <span class="kw">this</span>.<span class="fu">env</span> = hostEnvironment.<span class="fu">EnvironmentName</span>;</a>
<a class="sourceLine" id="cb1-17" title="17">        <span class="kw">this</span>.<span class="fu">OnEnv</span> = <span class="dt">string</span>.<span class="fu">IsNullOrEmpty</span>(onEnv) ? options.<span class="fu">Value</span>?.<span class="fu">EnvForDisableApiFilter</span> : onEnv;</a>
<a class="sourceLine" id="cb1-18" title="18">    }</a>
<a class="sourceLine" id="cb1-19" title="19"></a>
<a class="sourceLine" id="cb1-20" title="20">    <span class="co">/// </span><span class="kw">&lt;summary&gt;</span></a>
<a class="sourceLine" id="cb1-21" title="21">    <span class="co">/// Regression expression of ASPNETCORE_ENVIRONMENT for disabling API</span></a>
<a class="sourceLine" id="cb1-22" title="22">    <span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></a>
<a class="sourceLine" id="cb1-23" title="23">    <span class="kw">public</span> <span class="dt">string</span> OnEnv { <span class="kw">get</span>; <span class="kw">set</span>; }</a>
<a class="sourceLine" id="cb1-24" title="24"></a>
<a class="sourceLine" id="cb1-25" title="25">    <span class="co">/// </span><span class="kw">&lt;summary&gt;</span></a>
<a class="sourceLine" id="cb1-26" title="26">    <span class="co">/// OnResourceExecutionAsync</span></a>
<a class="sourceLine" id="cb1-27" title="27">    <span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></a>
<a class="sourceLine" id="cb1-28" title="28">    <span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">&quot;context&quot;</span><span class="kw">&gt;</span><span class="co">ResourceExecutingContext</span><span class="kw">&lt;/param&gt;</span></a>
<a class="sourceLine" id="cb1-29" title="29">    <span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">&quot;next&quot;</span><span class="kw">&gt;</span><span class="co">ResourceExecutionDelegate</span><span class="kw">&lt;/param&gt;</span></a>
<a class="sourceLine" id="cb1-30" title="30">    <span class="kw">public</span> async Task <span class="fu">OnResourceExecutionAsync</span>(ResourceExecutingContext context, ResourceExecutionDelegate next)</a>
<a class="sourceLine" id="cb1-31" title="31">    {</a>
<a class="sourceLine" id="cb1-32" title="32">        <span class="kw">if</span> (<span class="dt">string</span>.<span class="fu">IsNullOrEmpty</span>(<span class="kw">this</span>.<span class="fu">OnEnv</span>))</a>
<a class="sourceLine" id="cb1-33" title="33">        {</a>
<a class="sourceLine" id="cb1-34" title="34">            await <span class="fu">next</span>();</a>
<a class="sourceLine" id="cb1-35" title="35">        }</a>
<a class="sourceLine" id="cb1-36" title="36">        <span class="kw">else</span></a>
<a class="sourceLine" id="cb1-37" title="37">        {</a>
<a class="sourceLine" id="cb1-38" title="38">            <span class="dt">var</span> regex = <span class="kw">new</span> <span class="fu">Regex</span>(<span class="kw">this</span>.<span class="fu">OnEnv</span>);</a>
<a class="sourceLine" id="cb1-39" title="39"></a>
<a class="sourceLine" id="cb1-40" title="40">            <span class="kw">if</span> (regex.<span class="fu">IsMatch</span>(<span class="kw">this</span>.<span class="fu">env</span>))</a>
<a class="sourceLine" id="cb1-41" title="41">            {</a>
<a class="sourceLine" id="cb1-42" title="42">                context.<span class="fu">Result</span> = <span class="kw">new</span> <span class="fu">EmptyResult</span>();</a>
<a class="sourceLine" id="cb1-43" title="43">                context.<span class="fu">HttpContext</span>.<span class="fu">Response</span>.<span class="fu">StatusCode</span> = StatusCodes.<span class="fu">Status404NotFound</span>;</a>
<a class="sourceLine" id="cb1-44" title="44">            }</a>
<a class="sourceLine" id="cb1-45" title="45">            <span class="kw">else</span></a>
<a class="sourceLine" id="cb1-46" title="46">            {</a>
<a class="sourceLine" id="cb1-47" title="47">                await <span class="fu">next</span>();</a>
<a class="sourceLine" id="cb1-48" title="48">            }</a>
<a class="sourceLine" id="cb1-49" title="49">        }</a>
<a class="sourceLine" id="cb1-50" title="50">    }</a>
<a class="sourceLine" id="cb1-51" title="51">}</a></code></pre></div>
<h3 id="use-disabelapifilter-by-setting-regex-pattern">Use DisabelApiFilter by setting regex pattern</h3>
<p>The variable: <code>OnEnv</code>, is the parameter of the filter that supports Regular Expression. When environment variable: <code>ASPNETCORE_ENVIRONMENT</code> matches the <code>OnEnv</code>, the filter will force the API to return 404.</p>
<p>For example, the following API will responece 404 when <code>ASPNETCORE_ENVIRONMENT</code>’s value contains <code>Production</code> or <code>production</code>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb2-1" title="1">[<span class="fu">TypeFilter</span>(<span class="kw">typeof</span>(DisableApiFilter), Arguments = <span class="kw">new</span> <span class="dt">object</span>[] { <span class="st">&quot;^(.*)[Pp]roduction(.*)$&quot;</span> })]</a>
<a class="sourceLine" id="cb2-2" title="2">[HttpGet]</a>
<a class="sourceLine" id="cb2-3" title="3"><span class="kw">public</span> async Task&lt;IActionResult&gt; <span class="fu">Demo</span>()</a>
<a class="sourceLine" id="cb2-4" title="4">{}</a></code></pre></div>
<h3 id="use-disableapifilter-by-default-regex-pattern">Use DisableApiFilter by default regex pattern</h3>
<p>We can set a default regex pattern to be checked in <code>DisableApiFilter</code> when parameter <code>OnEnv</code> is not be specified.</p>
<ul>
<li>appsettings.json</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb3-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb3-2" title="2">  <span class="dt">&quot;EnvForDisableApiFilter&quot;</span><span class="fu">:</span> <span class="st">&quot;^(.*)[Pp]roduction(.*)$&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="fu">}</span></a></code></pre></div>
<p>And we can disable API on demand environment(s) like this,</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb4-1" title="1">[<span class="fu">TypeFilter</span>(<span class="kw">typeof</span>(DisableApiFilter))]</a>
<a class="sourceLine" id="cb4-2" title="2">[HttpGet]</a>
<a class="sourceLine" id="cb4-3" title="3"><span class="kw">public</span> async Task&lt;IActionResult&gt; <span class="fu">Demo</span>()</a>
<a class="sourceLine" id="cb4-4" title="4">{}</a></code></pre></div>
<h3 id="feature-management-configuration-from-other-service">Feature Management Configuration from other service</h3>
<p>We can implement <a href="https://github.com/microsoft/FeatureManagement-Dotnet/blob/main/src/Microsoft.FeatureManagement/IFeatureDefinitionProvider.cs">IFeatureDefinitionProvider</a> to get the Feature Management Configuration from other service’s API.</p>
<p>We will use <a href="https://github.com/typicode/json-server">json-server</a> to have an API running on <code>http://localhost:3000/feature-configuration</code>, which will returns the json configuration as below,</p>
<p><img src="assets/remote-feature-management-config.jpg" /></p>
<p>Now lets see how to load the configuration by implementing the custom <code>IFeatureDefinitionProvider</code>.</p>
<h4 id="implement-ifeaturedefinitionprovider">Implement IFeatureDefinitionProvider</h4>
<p>We can take a look at <a href="https://github.com/microsoft/FeatureManagement-Dotnet/blob/main/src/Microsoft.FeatureManagement/ConfigurationFeatureDefinitionProvider.cs">ConfigurationFeatureDefinitionProvider.cs</a> and try to create our custom one.</p>
<blockquote>
<p>The sample code also refer to the following article: <a href="https://dotblogs.com.tw/supershowwei/2020/11/23/180548">[料理佳餚] 實作 IFeatureDefinitionProvider 從外部的服務載入 ASP.NET Core Feature Flags（Feature Toggle）的設定</a></p>
</blockquote>
<ul>
<li>RemoteFeatureDefinitionProvider.cs</li>
</ul>
<p>The feature management definitions will be load from remote API and cache for a period of time in memory cache.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">public</span> <span class="kw">class</span> RemoteFeatureDefinitionProvider : IFeatureDefinitionProvider</a>
<a class="sourceLine" id="cb5-2" title="2">{</a>
<a class="sourceLine" id="cb5-3" title="3">    <span class="kw">private</span> <span class="dt">const</span> <span class="dt">string</span> FEATURE_MANAGEMENT_SECTION = <span class="st">&quot;FeatureManagement&quot;</span>;</a>
<a class="sourceLine" id="cb5-4" title="4">    <span class="kw">private</span> <span class="dt">const</span> <span class="dt">string</span> FFEATURE_FILTER_SECTION = <span class="st">&quot;EnabledFor&quot;</span>;</a>
<a class="sourceLine" id="cb5-5" title="5">    <span class="kw">private</span> <span class="dt">const</span> <span class="dt">int</span> CACHE_TIME = <span class="dv">180</span>; <span class="co">// Cache time in seconds</span></a>
<a class="sourceLine" id="cb5-6" title="6">    <span class="kw">private</span> <span class="kw">readonly</span> ILogger&lt;RemoteFeatureDefinitionProvider&gt; logger;</a>
<a class="sourceLine" id="cb5-7" title="7">    <span class="kw">private</span> <span class="kw">readonly</span> IHttpClientFactory httpClientFactory;</a>
<a class="sourceLine" id="cb5-8" title="8">    <span class="kw">private</span> <span class="kw">readonly</span> IMemoryCache memoryCache;</a>
<a class="sourceLine" id="cb5-9" title="9">    <span class="kw">private</span> ConcurrentDictionary&lt;<span class="dt">string</span>, FeatureDefinition&gt; definitions;</a>
<a class="sourceLine" id="cb5-10" title="10">    <span class="kw">private</span> IConfiguration configuration;</a>
<a class="sourceLine" id="cb5-11" title="11"></a>
<a class="sourceLine" id="cb5-12" title="12">    <span class="co">/// </span><span class="kw">&lt;summary&gt;</span></a>
<a class="sourceLine" id="cb5-13" title="13">    <span class="co">/// Custructor</span></a>
<a class="sourceLine" id="cb5-14" title="14">    <span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></a>
<a class="sourceLine" id="cb5-15" title="15">    <span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">&quot;logger&quot;</span><span class="kw">&gt;</span><span class="co">Logger</span><span class="kw">&lt;/param&gt;</span></a>
<a class="sourceLine" id="cb5-16" title="16">    <span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">&quot;httpClientFactory&quot;</span><span class="kw">&gt;</span><span class="co">HttpClientFactory</span><span class="kw">&lt;/param&gt;</span></a>
<a class="sourceLine" id="cb5-17" title="17">    <span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">&quot;memoryCache&quot;</span><span class="kw">&gt;</span><span class="co">Memory cache</span><span class="kw">&lt;/param&gt;</span></a>
<a class="sourceLine" id="cb5-18" title="18">    <span class="kw">public</span> <span class="fu">RemoteFeatureDefinitionProvider</span>(</a>
<a class="sourceLine" id="cb5-19" title="19">        ILogger&lt;RemoteFeatureDefinitionProvider&gt; logger,</a>
<a class="sourceLine" id="cb5-20" title="20">        IHttpClientFactory httpClientFactory,</a>
<a class="sourceLine" id="cb5-21" title="21">        IMemoryCache memoryCache)</a>
<a class="sourceLine" id="cb5-22" title="22">    {</a>
<a class="sourceLine" id="cb5-23" title="23">        <span class="kw">this</span>.<span class="fu">logger</span> = logger;</a>
<a class="sourceLine" id="cb5-24" title="24">        <span class="kw">this</span>.<span class="fu">httpClientFactory</span> = httpClientFactory;</a>
<a class="sourceLine" id="cb5-25" title="25">        <span class="kw">this</span>.<span class="fu">memoryCache</span> = memoryCache;</a>
<a class="sourceLine" id="cb5-26" title="26">        <span class="kw">this</span>.<span class="fu">definitions</span> = <span class="kw">new</span> ConcurrentDictionary&lt;<span class="dt">string</span>, FeatureDefinition&gt;();</a>
<a class="sourceLine" id="cb5-27" title="27">    }</a>
<a class="sourceLine" id="cb5-28" title="28"></a>
<a class="sourceLine" id="cb5-29" title="29">    <span class="co">/// </span><span class="kw">&lt;summary&gt;</span></a>
<a class="sourceLine" id="cb5-30" title="30">    <span class="co">/// Get all feature definitions</span></a>
<a class="sourceLine" id="cb5-31" title="31">    <span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></a>
<a class="sourceLine" id="cb5-32" title="32">    <span class="co">/// </span><span class="kw">&lt;returns&gt;</span><span class="co">Async enumerable of FeatrueDefinition</span><span class="kw">&lt;/returns&gt;</span></a>
<a class="sourceLine" id="cb5-33" title="33">    <span class="kw">public</span> async IAsyncEnumerable&lt;FeatureDefinition&gt; <span class="fu">GetAllFeatureDefinitionsAsync</span>()</a>
<a class="sourceLine" id="cb5-34" title="34">    {</a>
<a class="sourceLine" id="cb5-35" title="35">        await <span class="kw">this</span>.<span class="fu">reloadConfiguration</span>();</a>
<a class="sourceLine" id="cb5-36" title="36"></a>
<a class="sourceLine" id="cb5-37" title="37">        <span class="kw">foreach</span> (<span class="dt">var</span> featureSection <span class="kw">in</span> <span class="kw">this</span>.<span class="fu">getFeatureDefinitionSections</span>())</a>
<a class="sourceLine" id="cb5-38" title="38">        {</a>
<a class="sourceLine" id="cb5-39" title="39">            <span class="kw">yield</span> <span class="kw">return</span> <span class="kw">this</span>.<span class="fu">definitions</span>.<span class="fu">GetOrAdd</span>(featureSection.<span class="fu">Key</span>, _ =&gt; <span class="kw">this</span>.<span class="fu">readFeatureDefinition</span>(featureSection));</a>
<a class="sourceLine" id="cb5-40" title="40">        }</a>
<a class="sourceLine" id="cb5-41" title="41">    }</a>
<a class="sourceLine" id="cb5-42" title="42"></a>
<a class="sourceLine" id="cb5-43" title="43">    <span class="co">/// </span><span class="kw">&lt;summary&gt;</span></a>
<a class="sourceLine" id="cb5-44" title="44">    <span class="co">/// Get single feature definition</span></a>
<a class="sourceLine" id="cb5-45" title="45">    <span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></a>
<a class="sourceLine" id="cb5-46" title="46">    <span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">&quot;featureName&quot;</span><span class="kw">&gt;</span><span class="co">Feature name</span><span class="kw">&lt;/param&gt;</span></a>
<a class="sourceLine" id="cb5-47" title="47">    <span class="co">/// </span><span class="kw">&lt;returns&gt;</span><span class="co">FeatureDefinition</span><span class="kw">&lt;/returns&gt;</span></a>
<a class="sourceLine" id="cb5-48" title="48">    <span class="kw">public</span> async Task&lt;FeatureDefinition&gt; <span class="fu">GetFeatureDefinitionAsync</span>(<span class="dt">string</span> featureName)</a>
<a class="sourceLine" id="cb5-49" title="49">    {</a>
<a class="sourceLine" id="cb5-50" title="50">        <span class="kw">if</span> (featureName == <span class="kw">null</span>)</a>
<a class="sourceLine" id="cb5-51" title="51">        {</a>
<a class="sourceLine" id="cb5-52" title="52">            <span class="kw">throw</span> <span class="kw">new</span> <span class="fu">ArgumentNullException</span>(<span class="fu">nameof</span>(featureName));</a>
<a class="sourceLine" id="cb5-53" title="53">        }</a>
<a class="sourceLine" id="cb5-54" title="54"></a>
<a class="sourceLine" id="cb5-55" title="55">        await <span class="kw">this</span>.<span class="fu">reloadConfiguration</span>();</a>
<a class="sourceLine" id="cb5-56" title="56">        <span class="dt">var</span> definition = <span class="kw">this</span>.<span class="fu">definitions</span>.<span class="fu">GetOrAdd</span>(featureName, name =&gt; <span class="kw">this</span>.<span class="fu">readFeatureDefinition</span>(name));</a>
<a class="sourceLine" id="cb5-57" title="57">        <span class="kw">return</span> definition;</a>
<a class="sourceLine" id="cb5-58" title="58">    }</a>
<a class="sourceLine" id="cb5-59" title="59"></a>
<a class="sourceLine" id="cb5-60" title="60">    <span class="kw">private</span> async Task <span class="fu">reloadConfiguration</span>()</a>
<a class="sourceLine" id="cb5-61" title="61">    {</a>
<a class="sourceLine" id="cb5-62" title="62">        <span class="dt">string</span> remoteApiUri = <span class="kw">this</span>.<span class="fu">appSettings</span>.<span class="fu">FeatureManagementUri</span>;</a>
<a class="sourceLine" id="cb5-63" title="63">        <span class="kw">if</span> (!<span class="kw">this</span>.<span class="fu">memoryCache</span>.<span class="fu">TryGetValue</span>(CacheKeys.<span class="fu">FeatureConfig</span>, <span class="kw">out</span> IConfiguration featureConfig))</a>
<a class="sourceLine" id="cb5-64" title="64">        {</a>
<a class="sourceLine" id="cb5-65" title="65">            <span class="kw">this</span>.<span class="fu">definitions</span>.<span class="fu">Clear</span>();</a>
<a class="sourceLine" id="cb5-66" title="66"></a>
<a class="sourceLine" id="cb5-67" title="67">            <span class="kw">using</span> <span class="dt">var</span> httpClient = <span class="kw">this</span>.<span class="fu">httpClientFactory</span>.<span class="fu">CreateClient</span>();</a>
<a class="sourceLine" id="cb5-68" title="68">            <span class="dt">var</span> streamResponse = await httpClient.<span class="fu">GetStreamAsync</span>(<span class="st">&quot;http://localhost:3000/feature-management&quot;</span>); <span class="co">// Use json-server to run the json file at /AspNetCore.Filters.WebApi/Assets/feature_management.json</span></a>
<a class="sourceLine" id="cb5-69" title="69">            <span class="kw">this</span>.<span class="fu">configuration</span> = <span class="kw">new</span> <span class="fu">ConfigurationBuilder</span>().<span class="fu">AddJsonStream</span>(streamResponse).<span class="fu">Build</span>();</a>
<a class="sourceLine" id="cb5-70" title="70"></a>
<a class="sourceLine" id="cb5-71" title="71">            <span class="kw">this</span>.<span class="fu">memoryCache</span>.<span class="fu">Set</span>(CacheKeys.<span class="fu">FeatureConfig</span>, <span class="kw">this</span>.<span class="fu">configuration</span>, TimeSpan.<span class="fu">FromSeconds</span>(CACHE_TIME));</a>
<a class="sourceLine" id="cb5-72" title="72">        }</a>
<a class="sourceLine" id="cb5-73" title="73">        <span class="kw">else</span></a>
<a class="sourceLine" id="cb5-74" title="74">        {</a>
<a class="sourceLine" id="cb5-75" title="75">            <span class="kw">this</span>.<span class="fu">configuration</span> = featureConfig;</a>
<a class="sourceLine" id="cb5-76" title="76">        }</a>
<a class="sourceLine" id="cb5-77" title="77">    }</a>
<a class="sourceLine" id="cb5-78" title="78"></a>
<a class="sourceLine" id="cb5-79" title="79">    <span class="kw">private</span> FeatureDefinition <span class="fu">readFeatureDefinition</span>(<span class="dt">string</span> featureName)</a>
<a class="sourceLine" id="cb5-80" title="80">    {</a>
<a class="sourceLine" id="cb5-81" title="81">        <span class="dt">var</span> configurationSection = <span class="kw">this</span>.<span class="fu">getFeatureDefinitionSections</span>().<span class="fu">FirstOrDefault</span>(section =&gt; section.<span class="fu">Key</span>.<span class="fu">Equals</span>(featureName, StringComparison.<span class="fu">OrdinalIgnoreCase</span>));</a>
<a class="sourceLine" id="cb5-82" title="82"></a>
<a class="sourceLine" id="cb5-83" title="83">        <span class="kw">if</span> (configurationSection == <span class="kw">null</span>)</a>
<a class="sourceLine" id="cb5-84" title="84">        {</a>
<a class="sourceLine" id="cb5-85" title="85">            <span class="kw">return</span> <span class="kw">null</span>;</a>
<a class="sourceLine" id="cb5-86" title="86">        }</a>
<a class="sourceLine" id="cb5-87" title="87"></a>
<a class="sourceLine" id="cb5-88" title="88">        <span class="kw">return</span> <span class="kw">this</span>.<span class="fu">readFeatureDefinition</span>(configurationSection);</a>
<a class="sourceLine" id="cb5-89" title="89">    }</a>
<a class="sourceLine" id="cb5-90" title="90"></a>
<a class="sourceLine" id="cb5-91" title="91">    <span class="kw">private</span> FeatureDefinition <span class="fu">readFeatureDefinition</span>(IConfigurationSection configurationSection)</a>
<a class="sourceLine" id="cb5-92" title="92">    {</a>
<a class="sourceLine" id="cb5-93" title="93">        <span class="dt">var</span> enabledFor = <span class="kw">new</span> List&lt;FeatureFilterConfiguration&gt;();</a>
<a class="sourceLine" id="cb5-94" title="94"></a>
<a class="sourceLine" id="cb5-95" title="95">        <span class="dt">var</span> val = configurationSection.<span class="fu">Value</span>;</a>
<a class="sourceLine" id="cb5-96" title="96"></a>
<a class="sourceLine" id="cb5-97" title="97">        <span class="kw">if</span> (<span class="dt">string</span>.<span class="fu">IsNullOrEmpty</span>(val))</a>
<a class="sourceLine" id="cb5-98" title="98">        {</a>
<a class="sourceLine" id="cb5-99" title="99">            val = configurationSection[FFEATURE_FILTER_SECTION];</a>
<a class="sourceLine" id="cb5-100" title="100">        }</a>
<a class="sourceLine" id="cb5-101" title="101"></a>
<a class="sourceLine" id="cb5-102" title="102">        <span class="kw">if</span> (!<span class="dt">string</span>.<span class="fu">IsNullOrEmpty</span>(val) &amp;&amp; <span class="dt">bool</span>.<span class="fu">TryParse</span>(val, <span class="kw">out</span> <span class="dt">bool</span> result) &amp;&amp; result)</a>
<a class="sourceLine" id="cb5-103" title="103">        {</a>
<a class="sourceLine" id="cb5-104" title="104">            enabledFor.<span class="fu">Add</span>(<span class="kw">new</span> FeatureFilterConfiguration { Name = <span class="st">&quot;AlwaysOn&quot;</span> });</a>
<a class="sourceLine" id="cb5-105" title="105">        }</a>
<a class="sourceLine" id="cb5-106" title="106">        <span class="kw">else</span></a>
<a class="sourceLine" id="cb5-107" title="107">        {</a>
<a class="sourceLine" id="cb5-108" title="108">            <span class="dt">var</span> filterSections = configurationSection.<span class="fu">GetSection</span>(FFEATURE_FILTER_SECTION).<span class="fu">GetChildren</span>();</a>
<a class="sourceLine" id="cb5-109" title="109"></a>
<a class="sourceLine" id="cb5-110" title="110">            <span class="kw">foreach</span> (<span class="dt">var</span> filterSection <span class="kw">in</span> filterSections)</a>
<a class="sourceLine" id="cb5-111" title="111">            {</a>
<a class="sourceLine" id="cb5-112" title="112">                <span class="kw">if</span> (<span class="dt">int</span>.<span class="fu">TryParse</span>(filterSection.<span class="fu">Key</span>, <span class="kw">out</span> <span class="dt">int</span> i) &amp;&amp; !<span class="dt">string</span>.<span class="fu">IsNullOrEmpty</span>(filterSection[<span class="fu">nameof</span>(FeatureFilterConfiguration.<span class="fu">Name</span>)]))</a>
<a class="sourceLine" id="cb5-113" title="113">                {</a>
<a class="sourceLine" id="cb5-114" title="114">                    enabledFor.<span class="fu">Add</span>(</a>
<a class="sourceLine" id="cb5-115" title="115">                        <span class="kw">new</span> FeatureFilterConfiguration</a>
<a class="sourceLine" id="cb5-116" title="116">                        {</a>
<a class="sourceLine" id="cb5-117" title="117">                            Name = filterSection[<span class="fu">nameof</span>(FeatureFilterConfiguration.<span class="fu">Name</span>)],</a>
<a class="sourceLine" id="cb5-118" title="118">                            Parameters = filterSection.<span class="fu">GetSection</span>(<span class="fu">nameof</span>(FeatureFilterConfiguration.<span class="fu">Parameters</span>))</a>
<a class="sourceLine" id="cb5-119" title="119">                        });</a>
<a class="sourceLine" id="cb5-120" title="120">                }</a>
<a class="sourceLine" id="cb5-121" title="121">            }</a>
<a class="sourceLine" id="cb5-122" title="122">        }</a>
<a class="sourceLine" id="cb5-123" title="123"></a>
<a class="sourceLine" id="cb5-124" title="124">        <span class="kw">return</span> <span class="kw">new</span> FeatureDefinition { Name = configurationSection.<span class="fu">Key</span>, EnabledFor = enabledFor };</a>
<a class="sourceLine" id="cb5-125" title="125">    }</a>
<a class="sourceLine" id="cb5-126" title="126"></a>
<a class="sourceLine" id="cb5-127" title="127">    <span class="kw">private</span> IEnumerable&lt;IConfigurationSection&gt; <span class="fu">getFeatureDefinitionSections</span>()</a>
<a class="sourceLine" id="cb5-128" title="128">    {</a>
<a class="sourceLine" id="cb5-129" title="129">        <span class="dt">bool</span> isExist = <span class="kw">this</span>.<span class="fu">configuration</span>.<span class="fu">GetChildren</span>().<span class="fu">Any</span>(x =&gt; x.<span class="fu">Key</span>.<span class="fu">Equals</span>(FEATURE_MANAGEMENT_SECTION));</a>
<a class="sourceLine" id="cb5-130" title="130">        <span class="kw">if</span> (isExist)</a>
<a class="sourceLine" id="cb5-131" title="131">            <span class="kw">return</span> <span class="kw">this</span>.<span class="fu">configuration</span>.<span class="fu">GetSection</span>(FEATURE_MANAGEMENT_SECTION).<span class="fu">GetChildren</span>();</a>
<a class="sourceLine" id="cb5-132" title="132">        <span class="kw">else</span></a>
<a class="sourceLine" id="cb5-133" title="133">            <span class="kw">return</span> <span class="kw">this</span>.<span class="fu">configuration</span>.<span class="fu">GetChildren</span>();</a>
<a class="sourceLine" id="cb5-134" title="134">    }</a>
<a class="sourceLine" id="cb5-135" title="135">}</a></code></pre></div>
<h4 id="register-the-custom-remotefeaturedefinitionprovider">Register the custom RemoteFeatureDefinitionProvider</h4>
<p>Last step, we have to register the neccessary services and <code>RemoteFeatureDefinitionProvider</code> on <code>Starup.cs</code>.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode csharp"><code class="sourceCode cs"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">public</span> <span class="kw">class</span> Startup</a>
<a class="sourceLine" id="cb6-2" title="2">{</a>
<a class="sourceLine" id="cb6-3" title="3">    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">ConfigureServices</span>(IServiceCollection services)</a>
<a class="sourceLine" id="cb6-4" title="4">    {</a>
<a class="sourceLine" id="cb6-5" title="5">        services.<span class="fu">Configure</span>&lt;AppSettings&gt;(<span class="kw">this</span>.<span class="fu">Configuration</span>);</a>
<a class="sourceLine" id="cb6-6" title="6">        services.<span class="fu">AddHttpClient</span>();</a>
<a class="sourceLine" id="cb6-7" title="7">        services.<span class="fu">AddMemoryCache</span>();</a>
<a class="sourceLine" id="cb6-8" title="8"></a>
<a class="sourceLine" id="cb6-9" title="9">        <span class="co">// Add feature mangement services </span></a>
<a class="sourceLine" id="cb6-10" title="10">        services</a>
<a class="sourceLine" id="cb6-11" title="11">            .<span class="fu">AddSingleton</span>&lt;IFeatureDefinitionProvider, RemoteFeatureProvider&gt;()</a>
<a class="sourceLine" id="cb6-12" title="12">            .<span class="fu">AddFeatureManagement</span>();</a>
<a class="sourceLine" id="cb6-13" title="13"></a>
<a class="sourceLine" id="cb6-14" title="14">        services.<span class="fu">AddControllers</span>().<span class="fu">AddNewtonsoftJson</span>();</a>
<a class="sourceLine" id="cb6-15" title="15">    }</a>
<a class="sourceLine" id="cb6-16" title="16">}</a></code></pre></div>
<p>And don’t forget to remove the <code>FeatureManage</code> settings from <code>appsettings.json</code>!</p>
